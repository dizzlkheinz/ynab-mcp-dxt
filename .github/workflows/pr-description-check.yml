name: PR Description Check

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  check-description:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR Description Format
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const body = context.payload.pull_request.body || '';

            // Required sections from template
            const requiredSections = [
              'Type of change',
              'Public API surface checklist',
              'Versioning and release'
            ];

            const missingSections = requiredSections.filter(section =>
              !body.includes(section)
            );

            if (missingSections.length > 0) {
              // Build comment as array to avoid YAML indentation issues
              const commentLines = [
                '⚠️ **PR Description Check Failed**',
                '',
                'The PR description is missing required sections from the template:',
                ...missingSections.map(s => `- ${s}`),
                '',
                'Please update the description to include these sections. You can view the template at:',
                `https://github.com/${context.repo.owner}/${context.repo.repo}/blob/master/.github/pull_request_template.md`,
                '',
                'Or run this command to update it:',
                '```bash',
                `gh pr edit ${context.payload.pull_request.number} --body-file .github/pull_request_template.md`,
                '```'
              ];
              const comment = commentLines.join('\n');

              // Upsert comment: update existing bot comment or create new one
              const botCommentPrefix = '⚠️ **PR Description Check Failed**';
              // Paginate through all comments to handle PRs with >30 comments
              const comments = await github.paginate(
                github.rest.issues.listComments,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  per_page: 100
                }
              );

              const existingComment = comments.find(
                c => c.user.type === 'Bot' && c.body.startsWith(botCommentPrefix)
              );

              if (existingComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: comment
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: comment
                });
              }

              // Fail the check
              core.setFailed(`Missing required sections: ${missingSections.join(', ')}`);
            } else {
              console.log('✅ All required sections present in PR description');
            }
